name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  sonarcloud:
  name: SonarCloud Scan
  runs-on: ubuntu-latest

  steps:
    - uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

      - name: Disable host key checking
        run: |
          echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

      - name: Copy project files to EC2
        run: |
          rsync -avz --exclude "images/" --exclude "documents/" \
            -e "ssh -i ~/.ssh/ec2_key.pem" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/app/

      - name: Install dependencies and restart app on EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/${{ secrets.EC2_USER }}/app

            echo "Installing dependencies..."
            npm install

            echo "Building (if applicable)..."
            npm run build || echo "No build script"

            echo "Restarting app with PM2..."
            pm2 restart all || pm2 start app.js --name myapp

            echo "Saving PM2 process..."
            pm2 save
          EOF
          